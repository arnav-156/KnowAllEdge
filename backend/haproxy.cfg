# HAProxy Load Balancer Configuration (Alternative to Nginx)
# Place this in: /etc/haproxy/haproxy.cfg

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    
    # Performance tuning
    maxconn 4096
    tune.ssl.default-dh-param 2048
    
    # SSL configuration
    ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout connect 10s
    timeout client 120s
    timeout server 120s
    timeout http-request 10s
    timeout http-keep-alive 10s
    
    # Error files
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Statistics dashboard
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats show-node
    stats auth admin:changeme  # Change this password!
    
# Frontend - Accept incoming traffic
frontend KNOWALLEDGE_frontend
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/KNOWALLEDGE.pem
    
    # Redirect HTTP to HTTPS
    redirect scheme https code 301 if !{ ssl_fc }
    
    # Security headers
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Rate limiting (requires stick-table)
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
    
    # ACLs for routing
    acl is_health path_beg /api/health
    acl is_api path_beg /api/
    acl is_metrics path_beg /metrics
    
    # Use backend based on ACL
    use_backend KNOWALLEDGE_backend if is_health or is_api
    use_backend metrics_backend if is_metrics
    default_backend KNOWALLEDGE_backend

# Backend - Application servers
backend KNOWALLEDGE_backend
    balance leastconn  # Load balance by least connections
    
    # Health check configuration
    option httpchk GET /api/health
    http-check expect status 200
    
    # Backend servers (scale horizontally by adding more)
    server app1 127.0.0.1:5000 check inter 5s rise 2 fall 3 maxconn 100
    server app2 127.0.0.1:5001 check inter 5s rise 2 fall 3 maxconn 100
    server app3 127.0.0.1:5002 check inter 5s rise 2 fall 3 maxconn 100
    # Add more: server app4 127.0.0.1:5003 check inter 5s rise 2 fall 3 maxconn 100
    
    # Sticky sessions (if needed)
    # cookie SERVERID insert indirect nocache
    # server app1 127.0.0.1:5000 check cookie app1
    
    # Connection settings
    option http-keep-alive
    http-reuse safe
    
    # Error handling
    option abortonclose
    option redispatch
    
# Metrics backend (restricted access)
backend metrics_backend
    balance roundrobin
    
    # Restrict access to monitoring servers
    acl network_allowed src 127.0.0.1 10.0.0.0/8
    http-request deny unless network_allowed
    
    server app1 127.0.0.1:5000 check
    server app2 127.0.0.1:5001 check
    server app3 127.0.0.1:5002 check
