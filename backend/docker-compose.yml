# =============================================================================
# Production Docker Compose with Secrets Management
# Includes health checks, monitoring, and security best practices
# =============================================================================

version: '3.8'

# Docker Secrets for sensitive data (production)
secrets:
  google_api_key:
    file: ./secrets/google_api_key.txt
  redis_password:
    file: ./secrets/redis_password.txt
  jwt_secret:
    file: ./secrets/jwt_secret.txt

services:
  # Redis (shared state for sessions and cache)
  redis:
    image: redis:7-alpine
    container_name: KNOWALLEDGE-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
    secrets:
      - redis_password
    command: >
      sh -c "redis-server /usr/local/etc/redis/redis.conf 
      --requirepass $$(cat /run/secrets/redis_password) 
      --appendonly yes 
      --maxmemory 512mb 
      --maxmemory-policy allkeys-lru"
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "$$(cat /run/secrets/redis_password)", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - KNOWALLEDGE_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G

  # Backend Instance 1
  backend_1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: KNOWALLEDGE-backend-1
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_ENABLED=true
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - GOOGLE_API_KEY_FILE=/run/secrets/google_api_key
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - INSTANCE_ID=backend-1
      # Quota & Rate Limiting
      - QUOTA_RPM=15
      - QUOTA_RPD=1500
      - RATE_LIMIT_ENABLED=true
      # Caching
      - CACHE_BROWSER_TTL=300
      - CACHE_CDN_TTL=1800
      - CACHE_REDIS_TTL=3600
      - CACHE_PRECACHING=true
    secrets:
      - google_api_key
      - redis_password
      - jwt_secret
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - KNOWALLEDGE_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Backend Instance 2 (Scale horizontally)
  backend_2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: KNOWALLEDGE-backend-2
    ports:
      - "5001:5000"
    environment:
      - FLASK_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_ENABLED=true
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - GOOGLE_API_KEY_FILE=/run/secrets/google_api_key
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - INSTANCE_ID=backend-2
      - QUOTA_RPM=15
      - QUOTA_RPD=1500
      - RATE_LIMIT_ENABLED=true
      - CACHE_BROWSER_TTL=300
      - CACHE_CDN_TTL=1800
      - CACHE_REDIS_TTL=3600
      - CACHE_PRECACHING=true
    secrets:
      - google_api_key
      - redis_password
      - jwt_secret
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - KNOWALLEDGE_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Backend Instance 3 (Scale horizontally)
  backend_3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: KNOWALLEDGE-backend-3
    ports:
      - "5002:5000"
    environment:
      - FLASK_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_ENABLED=true
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - GOOGLE_API_KEY_FILE=/run/secrets/google_api_key
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - INSTANCE_ID=backend-3
      - QUOTA_RPM=15
      - QUOTA_RPD=1500
      - RATE_LIMIT_ENABLED=true
      - CACHE_BROWSER_TTL=300
      - CACHE_CDN_TTL=1800
      - CACHE_REDIS_TTL=3600
      - CACHE_PRECACHING=true
    secrets:
      - google_api_key
      - redis_password
      - jwt_secret
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - KNOWALLEDGE_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx Load Balancer
  nginx:
    image: nginx:alpine
    container_name: KNOWALLEDGE-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ssl:/etc/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - backend_1
      - backend_2
      - backend_3
    networks:
      - KNOWALLEDGE_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Prometheus (Monitoring)
  prometheus:
    image: prom/prometheus:latest
    container_name: KNOWALLEDGE-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    networks:
      - KNOWALLEDGE_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Grafana (Dashboards)
  grafana:
    image: grafana/grafana:latest
    container_name: KNOWALLEDGE-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD__FILE=/run/secrets/grafana_admin_password
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_INSTALL_PLUGINS=redis-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
    secrets:
      - source: grafana_admin_password
        target: /run/secrets/grafana_admin_password
    depends_on:
      - prometheus
    networks:
      - KNOWALLEDGE_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  redis_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  nginx_logs:
    driver: local

networks:
  KNOWALLEDGE_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# =============================================================================
# Setup Instructions:
# =============================================================================
# 
# 1. Create secrets directory:
#    mkdir -p secrets
# 
# 2. Create secret files:
#    echo "your_google_api_key" > secrets/google_api_key.txt
#    echo "$(openssl rand -base64 32)" > secrets/redis_password.txt
#    echo "$(openssl rand -base64 64)" > secrets/jwt_secret.txt
#    echo "admin_password" > secrets/grafana_admin_password.txt
# 
# 3. Set proper permissions:
#    chmod 600 secrets/*.txt
# 
# 4. Start services:
#    docker-compose up -d
# 
# 5. Scale backends (optional):
#    docker-compose up -d --scale backend_1=5
# 
# 6. Access:
#    - Application: http://localhost (Nginx)
#    - Direct backends: http://localhost:5000-5002
#    - Prometheus: http://localhost:9090
#    - Grafana: http://localhost:3000
# 
# 7. View logs:
#    docker-compose logs -f backend_1
# 
# 8. Stop services:
#    docker-compose down
# 
# =============================================================================
